# AGENTS.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

Asia Sweetmeat is an e-commerce web application for a traditional Asian sweets shop. It features a public storefront with product browsing, search, reviews, and a support ticket system ("Complain Box"), plus an admin dashboard for managing products, categories, and support tickets. The backend is Supabase (auth, Postgres DB, storage, realtime subscriptions).

## Commands

- `npm run dev` — Start Vite dev server on port 8080
- `npm run build` — Production build
- `npm run lint` — ESLint (flat config, TS/TSX only)
- `npm run test` — Run all tests once via Vitest
- `npm run test:watch` — Run tests in watch mode
- Run a single test file: `npx vitest run src/path/to/file.test.tsx`

## Tech Stack

- **Framework**: React 18 + TypeScript, bundled with Vite (SWC plugin)
- **Routing**: react-router-dom v6 (BrowserRouter, client-side routing)
- **State/Data**: TanStack React Query for server state; Supabase JS client for all DB/auth/storage/realtime operations
- **UI**: shadcn/ui components (Radix primitives + Tailwind CSS). Component source lives in `src/components/ui/`. The `components.json` configures shadcn with `rsc: false`, `tsx: true`, and path aliases.
- **Styling**: Tailwind CSS v3 with CSS custom properties for theming (light/dark mode via `class` strategy). All design tokens (colors, shadows, gradients, typography) are defined as CSS variables in `src/index.css` and mapped in `tailwind.config.ts`. Custom color tokens include `cream`, `golden`, `chocolate`, `coral`, and `warm-white`.
- **Fonts**: Playfair Display (headings via `font-display`), Poppins (body via `font-body`), Roboto (`font-sans`), Libre Caslon Text (`font-serif`), Roboto Mono (`font-mono`)
- **Forms**: react-hook-form + zod for validation
- **Testing**: Vitest + jsdom + @testing-library/react. Setup file at `src/test/setup.ts`. Test files match `src/**/*.{test,spec}.{ts,tsx}`.

## Architecture

### Path Alias

`@/` maps to `./src/` — configured in `tsconfig.json`, `vite.config.ts`, and `vitest.config.ts`.

### Routing (src/App.tsx)

- `/` — Homepage (Index)
- `/products` — Product listing with search/filter/sort
- `/product/:id` — Product detail page with reviews
- `/auth` — User authentication (sign-in/sign-up)
- `/auth/confirmed` — Post-auth confirmation
- `/profile` — User profile
- `/admin/login` — Admin login (username + password → `{username}@admin.local`)
- `/admin/*` — Admin dashboard (wrapped in `ProtectedRoute`, which checks `useAuth().isAdmin`)

Admin sub-routes (nested inside `AdminDashboard`): `/admin/products`, `/admin/categories`, `/admin/tickets`.

### Supabase Integration

- **Client**: `src/integrations/supabase/client.ts` — auto-generated, exports a typed `supabase` client. Import as `import { supabase } from "@/integrations/supabase/client"`.
- **Types**: `src/integrations/supabase/types.ts` — auto-generated Database types. Use `Tables<"table_name">`, `TablesInsert<"table_name">`, `TablesUpdate<"table_name">` for typed row access.
- **Do not manually edit** files in `src/integrations/supabase/` — they are auto-generated.
- **Env vars** (in `.env`): `VITE_SUPABASE_URL`, `VITE_SUPABASE_PUBLISHABLE_KEY`, `VITE_SUPABASE_PROJECT_ID`. All must be prefixed with `VITE_` to be exposed to the client.

### Database Schema (Supabase Postgres)

Tables: `categories`, `products` (FK → categories), `reviews` (FK → products), `support_tickets`, `ticket_messages` (FK → support_tickets), `notifications` (FK → support_tickets), `user_roles`.

Enum `app_role`: `"admin" | "moderator" | "user"`. DB function `has_role(_role, _user_id)` checks roles.

Migrations are in `supabase/migrations/`. Edge functions in `supabase/functions/`.

### Authentication & Authorization

`src/hooks/useAuth.ts` manages auth state. It returns `{ user, session, loading, isAdmin, loginAsAdmin, logout }`. Admin check queries `user_roles` table for `role = "admin"`. Admin login converts username to `{username}@admin.local` email format.

`src/components/admin/ProtectedRoute.tsx` gates all `/admin/*` routes — redirects to `/admin/login` if not authenticated or not admin.

### Realtime

The `SupportTicketWidget` and admin `TicketsManager` use Supabase realtime channels (`postgres_changes`) to listen for new messages and notifications without polling.

### Lovable Integration

`src/integrations/lovable/index.ts` is auto-generated by Lovable (the platform this project was scaffolded from). It provides OAuth sign-in via Google/Apple. Do not manually edit.

### Key Component Patterns

- Public pages share a common layout: `<Navbar />` → content → `<Footer />` → `<SupportTicketWidget />`.
- Products are priced in BDT (৳) per kg.
- The `cn()` utility from `src/lib/utils.ts` merges Tailwind classes (clsx + tailwind-merge).
- Custom CSS component classes (`.nav-link`, `.section-title`, `.card-sweet`, `.btn-primary`, `.btn-outline`) are defined in `src/index.css` under `@layer components`.

### TypeScript Config

Strict mode is off (`strict: false`). `noImplicitAny`, `noUnusedLocals`, `noUnusedParameters` are all disabled. `strictNullChecks` is off.

### Deployment

Deployed on Vercel with SPA rewrite rule (`vercel.json`: all routes → `/`).
